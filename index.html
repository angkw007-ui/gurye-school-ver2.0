<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì£¼ê°„ê³„íš</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="êµ¬ë¡€ì¤‘">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background-color: #f8fafc; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { height: 80px; background-color: white; padding: 4px; position: relative; cursor: pointer; transition: background-color 0.2s; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 768px) { .day-cell { height: 120px; padding: 8px; } }
        .day-cell:hover { background-color: #f1f5f9; }

        /* âœ… ì›”ê°„ë·° ì¼ì •: ê³ ì • ë†’ì´ í•œ ì¤„, ë§ì¤„ì„ */
        .event-item { 
            font-size: 11px; 
            padding: 2px 4px; 
            border-radius: 3px; 
            background-color: #f1f5f9; 
            border-left: 2px solid #16a34a; 
            font-weight: 700; 
            display: block; 
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            cursor: pointer; 
            transition: all 0.2s; 
            flex-shrink: 0;
            height: 18px;
            line-height: 14px;
            box-sizing: border-box;
        }
        @media (min-width: 768px) { 
            .event-item { 
                font-size: 12px; 
                padding: 3px 6px; 
                height: 20px;
                line-height: 14px;
            } 
        }
        .event-item:hover { background-color: #e0f2fe; }
        .event-more { font-size: 10px; color: #64748b; font-weight: 700; padding: 1px 4px; flex-shrink: 0; }
        @media (min-width: 768px) { .event-more { font-size: 11px; } }

        /* âœ… ì£¼ê°„ë·° ì¼ì •: ê°€ë³€ ë†’ì´, ì‚­ì œë²„íŠ¼ í¬í•¨ flex */
        .event-item-week {
            font-size: 13px;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 5px;
            background-color: #f1f5f9;
            border-left: 3px solid #16a34a;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            word-break: break-all;
        }
        @media (min-width: 768px) { .event-item-week { font-size: 14px; } }
        .event-item-week:hover { background-color: #e0f2fe; }

        /* âœ… ì›”ê°„ë·° ë‚ ì§œ ì…€ ë‚´ë¶€ êµ¬ì¡° */
        .day-cell-header { font-size: 10px; font-weight: 900; margin-bottom: 2px; flex-shrink: 0; }
        @media (min-width: 768px) { .day-cell-header { font-size: 13px; margin-bottom: 4px; } }
        .day-cell-holiday { font-size: 10px; color: #dc2626; font-weight: 700; margin-bottom: 2px; flex-shrink: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (min-width: 768px) { .day-cell-holiday { font-size: 12px; } }
        .day-cell-events { flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 1px; min-height: 0; }

        /* âœ… 2. ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
        .today-border { outline: 3px solid #ef4444 !important; outline-offset: -3px; z-index: 10; position: relative; border-radius: 8px; }

        .dept-êµë¬´ { color: #15803d; border-left-color: #15803d; }
        .dept-ì—°êµ¬ { color: #059669; border-left-color: #059669; }
        .dept-í•™ìƒ { color: #d97706; border-left-color: #d97706; }
        .dept-ì°½ì˜ { color: #7c3aed; border-left-color: #7c3aed; }
        .dept-í–‰ì • { color: #475569; border-left-color: #475569; }
        .dept-1í•™ë…„ { color: #2563eb; border-left-color: #2563eb; }
        .dept-2í•™ë…„ { color: #db2777; border-left-color: #db2777; }
        .dept-3í•™ë…„ { color: #0891b2; border-left-color: #0891b2; }
        .dept-í•™ì‚¬ { color: #1e293b; border-left-color: #1e293b; }

        .holiday-badge { font-size: 11px; color: #dc2626; font-weight: 700; margin-top: 1px; }
        @media (min-width: 768px) { .holiday-badge { font-size: 13px; } }

        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; font-weight: bold; }

        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .year-month { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .year-month-title { font-weight: 900; color: #1e293b; margin-bottom: 8px; font-size: 16px; }
        @media (min-width: 768px) { .year-month-title { font-size: 18px; } }

        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 10px; }
        @media (min-width: 768px) { .mini-calendar { font-size: 12px; } }

        .mini-day { padding: 4px; text-align: center; min-height: 30px; background: #f8fafc; border-radius: 4px; cursor: pointer; }
        @media (min-width: 768px) { .mini-day { min-height: 36px; padding: 6px; } }
        .mini-day.has-event { background: #dcfce7; font-weight: 700; }
        .mini-day.weekend { background: #fee2e2; }

        .week-item { background-color: white; }
        .weekend-bg, .holiday-bg { background-color: #fff1f2 !important; }

        .notice-section { background-color: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .notice-list { display: flex; flex-direction: column; gap: 12px; }
        .notice-box { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .notice-header { display: flex; justify-content: space-between; align-items: center; }
        .notice-label { font-size: 13px; font-weight: 800; color: #15803d; }
        @media (min-width: 768px) { .notice-label { font-size: 15px; } }

        .notice-input { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; outline: none; transition: all 0.2s; min-height: 60px; resize: vertical; background-color: white; font-weight: normal; }
        @media (min-width: 768px) { .notice-input { font-size: 15px; padding: 12px; min-height: 70px; } }
        .notice-input.has-content { background-color: #fef9c3 !important; border-color: #facc15; }
        .notice-input:focus { border-color: #16a34a; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }

        .week-date-label { font-size: 15px; font-weight: 900; line-height: 1.3; }
        @media (min-width: 768px) { .week-date-label { font-size: 17px; } }

        /* ===== íšŒì˜ë©”ëª¨ ë·° ===== */
        .meeting-wrapper { display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
        @media (min-width: 768px) { .meeting-wrapper { flex-direction: row; align-items: flex-start; gap: 20px; } }

        .meeting-cal-panel { background: white; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; }
        @media (min-width: 768px) { .meeting-cal-panel { width: 300px; } }

        .meeting-calendar-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 10px 14px; color: white; }
        .meeting-calendar-header button { background: rgba(255,255,255,0.25); color: white; font-weight: bold; padding: 4px 10px; border-radius: 6px; font-size: 14px; transition: all 0.2s; }
        .meeting-calendar-header button:hover { background: rgba(255,255,255,0.4); }
        .meeting-calendar-title { font-size: 15px; font-weight: 900; }

        .meeting-calendar-body { padding: 8px; }
        .meeting-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .meeting-calendar-day-header { text-align: center; font-weight: 700; color: #64748b; padding: 4px 2px; font-size: 11px; }

        .meeting-calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.15s; background: #f8fafc; position: relative; }
        .meeting-calendar-day:hover { background: #e0f2fe; transform: scale(1.05); }
        .meeting-calendar-day.selected { background: #16a34a !important; color: white !important; font-weight: 900; box-shadow: 0 2px 6px rgba(22,163,74,0.4); }
        .meeting-calendar-day.today-border { outline: 3px solid #ef4444 !important; outline-offset: -3px; }
        .meeting-calendar-day.weekend { background: #fef2f2; color: #ef4444; }
        .meeting-calendar-day.other-month { color: #cbd5e1; background: transparent; font-size: 10px; }
        .meeting-calendar-day.has-meeting::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background: #16a34a; }
        .meeting-calendar-day.selected.has-meeting::after { background: white; }

        .meeting-input-panel { flex: 1; background: white; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 16px; min-width: 0; }
        .meeting-panel-title { font-size: 14px; font-weight: 900; color: #15803d; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #dcfce7; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .meeting-date-badge { background: #dcfce7; color: #15803d; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }

        .meeting-label { font-size: 13px; font-weight: 800; color: #374151; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        @media (min-width: 768px) { .meeting-label { font-size: 14px; } }

        .ai-generate-btn { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(124,58,237,0.3); border: none; }
        .ai-generate-btn:hover { transform: scale(1.05); }
        .ai-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .meeting-input { width: 100%; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; transition: all 0.2s; font-family: inherit; margin-bottom: 12px; box-sizing: border-box; }
        .meeting-input:focus { border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22,163,74,0.1); }

        .meeting-textarea { width: 100%; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; font-size: 13px; outline: none; transition: all 0.2s; min-height: 300px; resize: vertical; line-height: 1.8; font-family: inherit; box-sizing: border-box; }
        @media (min-width: 768px) { .meeting-textarea { min-height: 380px; font-size: 14px; } }
        .meeting-textarea:focus { border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22,163,74,0.1); }

        .meeting-input.has-data, .meeting-textarea.has-data { background-color: #fefce8; border-color: #facc15; }

        .save-indicator { font-size: 11px; color: #94a3b8; text-align: right; margin-top: 6px; }
        .save-indicator.saving { color: #f59e0b; }
        .save-indicator.saved { color: #16a34a; }

        /* ===== ë³µìˆ˜ íšŒì˜ ì¹´ë“œ ===== */
        .meeting-card { background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 14px; margin-bottom: 12px; position: relative; transition: border-color 0.2s; }
        .meeting-card:hover { border-color: #16a34a; }
        .meeting-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .meeting-card-num { font-size: 12px; font-weight: 900; color: #16a34a; background: #dcfce7; padding: 2px 10px; border-radius: 20px; }
        .meeting-card-del { font-size: 13px; color: #ef4444; cursor: pointer; font-weight: bold; padding: 2px 8px; border-radius: 6px; background: #fee2e2; transition: all 0.2s; }
        .meeting-card-del:hover { background: #fca5a5; }
        .add-meeting-btn { width: 100%; padding: 10px; border: 2px dashed #16a34a; border-radius: 10px; color: #16a34a; font-weight: 900; font-size: 14px; cursor: pointer; background: white; transition: all 0.2s; margin-top: 4px; }
        .add-meeting-btn:hover { background: #f0fdf4; }

        /* AI ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .ai-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(124,58,237,0.08);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; z-index: 100; }
        .ai-spinner { font-size: 13px; font-weight: 700; color: #7c3aed; text-align: center; }

        .install-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(22,163,74,0.3); cursor: pointer; border: none; transition: all 0.3s; z-index: 999; }
        .install-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(22,163,74,0.4); }

        @media (max-width: 767px) {
            html, body { height: auto; }
            body { overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .meeting-wrapper { -webkit-overflow-scrolling: touch; }
            .meeting-textarea { touch-action: pan-y; -webkit-overflow-scrolling: touch; }
        }

        /* ì—ëŸ¬ í† ìŠ¤íŠ¸ */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 9999; opacity: 0; transition: opacity 0.3s; max-width: 90vw; text-align: center; }
        .toast.show { opacity: 1; }
        .toast.error { background: #dc2626; }
        .toast.success { background: #16a34a; }

        /* ===== ë…¹ìŒ ê¸°ëŠ¥ ===== */
        .record-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; padding: 4px 12px; border-radius: 6px;
            font-size: 11px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(239,68,68,0.3);
            border: none; margin-left: 6px;
        }
        .record-btn:hover { transform: scale(1.05); }
        .record-btn.recording {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            animation: pulse-red 1s infinite;
        }
        .record-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 2px 5px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 2px 16px rgba(239,68,68,0.8); }
        }
        .record-status {
            font-size: 11px; color: #ef4444; font-weight: 700;
            margin-top: 4px; min-height: 16px; text-align: right;
        }
        .transcript-preview {
            font-size: 12px; color: #64748b; font-style: italic;
            background: #fef2f2; border: 1px dashed #fca5a5;
            border-radius: 6px; padding: 6px 10px; margin-top: 6px;
            min-height: 32px; display: none;
        }
        .transcript-preview.visible { display: block; }

        /* PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
        .pdf-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white; padding: 4px 12px; border-radius: 6px;
            font-size: 11px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(14,165,233,0.3);
            border: none; margin-left: 6px;
        }
        .pdf-btn:hover { transform: scale(1.05); }
        .pdf-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* ë…¹ìŒíŒŒì¼ ë“±ë¡ ë²„íŠ¼ */
        .audio-upload-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white; padding: 4px 12px; border-radius: 6px;
            font-size: 11px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(245,158,11,0.3);
            display: inline-flex; align-items: center; margin-left: 6px;
        }
        .audio-upload-btn:hover { transform: scale(1.05); }

        /* PDF ì¶œë ¥ìš© ìˆ¨ê²¨ì§„ ì˜ì—­ */
        @media print {
            body * { visibility: hidden; }
            #pdfPrintArea, #pdfPrintArea * { visibility: visible; }
            #pdfPrintArea { position: fixed; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì£¼ê°„ ê³„íš</h1>
            <div class="flex gap-1 md:gap-2">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">ì—°ê°„</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">ğŸ“íšŒì˜ë©”ëª¨</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <input type="text" id="inTitle" placeholder="ì—…ë¬´ í–‰ì‚¬ ì…ë ¥" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm md:text-base outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
                <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm md:text-base hover:bg-green-700">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-lg md:text-xl hover:text-green-800">â®</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-lg md:text-xl hover:text-green-800">â¯</button>
        </div>

        <div id="viewPort"></div>

        <div id="noticePort" class="hidden">
            <div class="notice-section">
                <h3 class="font-black text-green-800 mb-4 flex items-center gap-2 text-base md:text-lg">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
                <div class="notice-list">
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµì¥</label></div><textarea data-dept="êµì¥" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµê°</label></div><textarea data-dept="êµê°" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í–‰ì •ì‹¤ì¥</label></div><textarea data-dept="í–‰ì •ì‹¤" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµë¬´ë¶€</label></div><textarea data-dept="êµë¬´ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ì—°êµ¬ë¶€</label></div><textarea data-dept="ì—°êµ¬ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í•™ìƒë¶€</label></div><textarea data-dept="í•™ìƒë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ì°½ì˜ì¸ì„±ë¶€</label></div><textarea data-dept="ì°½ì˜ì¸ì„±ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í•™ë…„ì‹¤</label></div><textarea data-dept="í•™ë…„ì‹¤" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                </div>
            </div>
        </div>

        <footer class="text-center py-8 text-slate-400 text-[10px] md:text-xs">
            Â© Developed by Choi Gwang-cheol of Gurye Middle School in 2026. All rights reserved.
        </footer>
    </div>

    <div id="toast" class="toast"></div>
    <button id="installBtn" class="install-btn" style="display: none;" onclick="app.handleInstall()">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</button>

    <div id="iosInstallModal" class="modal" onclick="document.getElementById('iosInstallModal').style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
            <div style="font-size:32px; margin-bottom:12px;">ğŸ“±</div>
            <h3 style="font-weight:900; color:#15803d; margin-bottom:12px; font-size:16px;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</h3>
            <div style="background:#f0fdf4; border-radius:12px; padding:16px; margin-bottom:16px; text-align:left; font-size:14px; line-height:1.8;">
                <div style="margin-bottom:8px;">1ï¸âƒ£ í•˜ë‹¨ <strong>ê³µìœ  ë²„íŠ¼</strong> íƒ­ <span style="font-size:18px;">â¬†ï¸</span></div>
                <div style="margin-bottom:8px;">2ï¸âƒ£ <strong>"í™ˆ í™”ë©´ì— ì¶”ê°€"</strong> ì„ íƒ</div>
                <div>3ï¸âƒ£ ì˜¤ë¥¸ìª½ ìœ„ <strong>"ì¶”ê°€"</strong> íƒ­</div>
            </div>
            <button onclick="document.getElementById('iosInstallModal').style.display='none'"
                style="width:100%; background:#15803d; color:white; font-weight:bold; padding:12px; border-radius:12px; border:none; font-size:15px; cursor:pointer;">í™•ì¸</button>
        </div>
    </div>

    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-2 text-base md:text-lg"></h3>
            <div id="modalContent" class="space-y-2 max-h-60 overflow-y-auto mb-4 text-sm md:text-base"></div>
            <button onclick="app.closeModal()" class="w-full bg-green-600 text-white font-bold py-2 rounded-xl text-sm md:text-base hover:bg-green-700">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const app = {
            // âœ… GAS ë°°í¬ ì£¼ì†Œ
            API_URL: 'https://script.google.com/macros/s/AKfycbzQqONXTaXF09QGbN94DvUxJyrjF0HHMFbPE97Onl32IA19t12B9HvuEZMZlwcmLIOu/exec',
            events: [],
            localChanges: {},
            localDeletes: new Set(),
            currentDate: new Date(),
            viewMode: 'weekly',
            isSyncing: false,
            isEditing: false,
            meetingInputFocused: false,
            saveTimers: {},
            savingInProgress: false,
            pendingSave: null,
            aiGenerating: false,
            meetingDate: new Date(),
            meetingCalendarDate: new Date(),
            days: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],

            holidays: [
                '2026-01-01:ì‹ ì •', '2026-02-16:ì„¤ë‚ ì—°íœ´', '2026-02-17:ì„¤ë‚ ', '2026-02-18:ì„¤ë‚ ì—°íœ´',
                '2026-03-01:ì‚¼ì¼ì ˆ', '2026-03-02:ëŒ€ì²´ê³µíœ´ì¼', '2026-05-05:ì–´ë¦°ì´ë‚ ', '2026-05-24:ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
                '2026-05-25:ëŒ€ì²´ê³µíœ´ì¼', '2026-06-06:í˜„ì¶©ì¼', '2026-08-15:ê´‘ë³µì ˆ', '2026-08-17:ëŒ€ì²´ê³µíœ´ì¼',
                '2026-09-24:ì¶”ì„ì—°íœ´', '2026-09-25:ì¶”ì„', '2026-09-26:ì¶”ì„ì—°íœ´', '2026-10-03:ê°œì²œì ˆ',
                '2026-10-05:ëŒ€ì²´ê³µíœ´ì¼', '2026-10-09:í•œê¸€ë‚ ', '2026-12-25:í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
            ],

            // âœ… 3. ë‚ ì§œ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ íƒ€ì„ì¡´ ë¬¸ì œ ì™„ë²½íˆ í•´ê²°
            parseLocalDate(dateStr) {
                // dateStr í˜•ì‹: "YYYY-MM-DD" (input[type="date"]ì˜ ê°’)
                // íƒ€ì„ì¡´ ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ ì§ì ‘ íŒŒì‹±
                const parts = dateStr.split('-');
                if (parts.length !== 3) return new Date();
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            },

            // âœ… 2. ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸ ë¡œì§
            isToday(dateStr) {
                const today = this.formatDate(new Date());
                return dateStr === today;
            },

            showToast(msg, type = 'info', duration = 3500) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `toast show ${type}`;
                clearTimeout(this._toastTimer);
                this._toastTimer = setTimeout(() => { toast.className = 'toast'; }, duration);
            },

            getHoliday(dateStr) {
                const found = this.holidays.find(h => h.startsWith(dateStr));
                return found ? found.split(':')[1] : null;
            },

            isSpecialHoliday(dateStr) {
                return this.events.some(e => e.date === dateStr && (e.title.includes('ì¬ëŸ‰íœ´ì—…ì¼') || e.title.includes('íœ´ì—…ì¼') || e.title.includes('íœ´ë¬´ì¼')));
            },

            isMeetingInputActive() {
                const activeEl = document.activeElement;
                if (!activeEl) return false;
                return activeEl.closest('.meeting-card') !== null ||
                       activeEl.classList.contains('meeting-input') ||
                       activeEl.classList.contains('meeting-textarea');
            },

            getMeetingsForDate(dateStr) {
                const prefix = `meeting_${dateStr}_`;
                const all = this.events.filter(e => e.id.startsWith(prefix)).map(e => ({...e}));
                Object.keys(this.localChanges).forEach(id => {
                    if (id.startsWith(prefix) && !all.find(e => e.id === id)) {
                        all.push({...this.localChanges[id]});
                    }
                });
                return all.filter(e => !this.localDeletes.has(e.id))
                          .sort((a, b) => a.id.localeCompare(b.id));
            },

            newMeetingId(dateStr) {
                const existing = this.getMeetingsForDate(dateStr);
                const nums = existing.map(e => parseInt(e.id.split('_').pop()) || 0);
                const next = nums.length > 0 ? Math.max(...nums) + 1 : 1;
                return `meeting_${dateStr}_${next}`;
            },

            async loadFromServer() {
                if (this.isSyncing) return;
                if (this.aiGenerating) return;
                try {
                    this.isSyncing = true;
                    const response = await fetch(this.API_URL + '?t=' + Date.now());
                    const data = await response.json();

                    const serverEvents = data.map(item => {
                        let dateStr = item.date;
                        if (typeof dateStr === 'number') {
                            // êµ¬ê¸€ ì‹œíŠ¸ ì§ë ¬ ë‚ ì§œ (1900-01-01 ê¸°ì¤€ ì¼ìˆ˜)
                            const d = new Date(Math.round((dateStr - 25569) * 86400 * 1000));
                            dateStr = this.formatDate(new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
                        } else if (typeof dateStr === 'string' && dateStr.includes('T')) {
                            // ISO ë¬¸ìì—´ â†’ í•œêµ­ ì‹œê°„(UTC+9) ê¸°ì¤€ ë‚ ì§œ ì¶”ì¶œ
                            const d = new Date(dateStr);
                            const kst = new Date(d.getTime() + 9 * 60 * 60 * 1000);
                            dateStr = this.formatDate(new Date(kst.getUTCFullYear(), kst.getUTCMonth(), kst.getUTCDate()));
                        } else if (typeof dateStr === 'string') {
                            dateStr = dateStr.substring(0, 10);
                        }
                        return {
                            id: String(item.id),
                            date: dateStr,
                            title: item.title,
                            dapt: item.dapt,
                            subject: item.subject || '',
                            content: item.content || ''
                        };
                    });

                    this.events = this.mergeEvents(serverEvents);

                    if (this.viewMode === 'meeting') {
                        this.renderMeetingCalendar();
                        if (!this.isMeetingInputActive() && !this.meetingInputFocused) {
                            this.syncMeetingInputsFromData();
                        }
                    } else if (!this.isEditing) {
                        this.render();
                    }
                } catch (error) {
                    console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                } finally {
                    this.isSyncing = false;
                }
            },

            syncMeetingInputsFromData() {
                if (!document.getElementById('meetingCardsContainer')) return;
                this.renderMeetingCards();
                this.updateMeetingPanelDate();
            },

            mergeEvents(serverEvents) {
                const filtered = serverEvents.filter(e => !this.localDeletes.has(String(e.id)));
                const merged = [...filtered];
                Object.keys(this.localChanges).forEach(id => {
                    const localData = this.localChanges[id];
                    const serverIndex = merged.findIndex(e => String(e.id) === String(id));
                    if (serverIndex !== -1) merged[serverIndex] = { ...merged[serverIndex], ...localData };
                    else merged.push(localData);
                });
                return merged;
            },

            async saveToServer(action, data) {
                if (action === 'add') {
                    this.localChanges[data.id] = data;
                    this.localDeletes.delete(data.id);
                } else if (action === 'delete') {
                    delete this.localChanges[data.id];
                    this.localDeletes.add(data.id);
                }

                if (this.savingInProgress) {
                    this.pendingSave = { action, data };
                    return;
                }
                this.savingInProgress = true;
                try {
                    const response = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...data })
                    });
                    const result = await response.json();
                    if (result.success) {
                        const savedId = data.id;
                        setTimeout(() => {
                            delete this.localChanges[savedId];
                            this.localDeletes.delete(savedId);
                        }, 15000);
                        this.showSaveIndicator('saved');
                    }
                } catch (error) {
                    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                } finally {
                    this.savingInProgress = false;
                    if (this.pendingSave) {
                        const pending = this.pendingSave;
                        this.pendingSave = null;
                        await this.saveToServer(pending.action, pending.data);
                    }
                }
            },

            showSaveIndicator(status) {
                const el = document.getElementById('meetingSaveIndicator');
                if (!el) return;
                el.className = 'save-indicator ' + status;
                if (status === 'saving') el.textContent = 'ğŸ’¾ ì €ì¥ ì¤‘...';
                else if (status === 'saved') el.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
                else el.textContent = 'ğŸ’¡ ì…ë ¥ 2ì´ˆ í›„ ìë™ ì €ì¥';
            },

            handleNoticeInput(input) {
                this.isEditing = true;
                this.updateInputStyle(input);
                const dept = input.dataset.dept;
                if (this.saveTimers[dept]) clearTimeout(this.saveTimers[dept]);
                this.saveTimers[dept] = setTimeout(() => { this.saveNotice(input); }, 2000);
            },

            updateInputStyle(input) {
                if (input.value.trim() !== '') input.classList.add('has-content');
                else input.classList.remove('has-content');
            },

            async saveNotice(input) {
                this.isEditing = false;
                const dept = input.dataset.dept;
                const content = input.value.trim();
                const monday = this.getMonday(this.currentDate);
                const dateStr = this.formatDate(monday);
                const noticeId = `notice_${dateStr}_${dept}`;
                const existingIndex = this.events.findIndex(e => e.id === noticeId);
                if (content === '') {
                    if (existingIndex !== -1) {
                        this.events.splice(existingIndex, 1);
                        await this.saveToServer('delete', { id: noticeId });
                    }
                } else {
                    const newNotice = { id: noticeId, date: dateStr, title: content, dapt: dept };
                    if (existingIndex !== -1) this.events[existingIndex] = newNotice;
                    else this.events.push(newNotice);
                    await this.saveToServer('add', newNotice);
                }
            },

            moveMeetingCalendar(direction) {
                this.meetingCalendarDate.setMonth(this.meetingCalendarDate.getMonth() + direction);
                this.renderMeetingCalendar();
            },

            selectMeetingDate(dateStr) {
                this.meetingDate = this.parseLocalDate(dateStr);
                this.meetingCalendarDate = this.parseLocalDate(dateStr);
                this.updateMeetingPanelDate();
                this.renderMeetingCards();
                this.renderMeetingCalendar();
            },

            updateMeetingPanelDate() {
                const el = document.getElementById('meetingPanelDate');
                if (!el) return;
                const dateStr = this.formatDate(this.meetingDate);
                const dayOfWeek = this.days[this.meetingDate.getDay()];
                el.textContent = `${dateStr} (${dayOfWeek})`;
            },

            renderMeetingCalendar() {
                const year = this.meetingCalendarDate.getFullYear();
                const month = this.meetingCalendarDate.getMonth();
                const selectedDateStr = this.formatDate(this.meetingDate);
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const prevLastDate = new Date(year, month, 0).getDate();

                let html = `
                    <div class="meeting-calendar-header">
                        <button onclick="app.moveMeetingCalendar(-1)">â—€</button>
                        <div class="meeting-calendar-title">${year}ë…„ ${month + 1}ì›”</div>
                        <button onclick="app.moveMeetingCalendar(1)">â–¶</button>
                    </div>
                    <div class="meeting-calendar-body">
                        <div class="meeting-calendar-grid">`;
                this.days.forEach(day => {
                    const colorClass = day === 'ì¼' ? 'text-red-500' : (day === 'í† ' ? 'text-blue-500' : '');
                    html += `<div class="meeting-calendar-day-header ${colorClass}">${day}</div>`;
                });
                for (let i = firstDay - 1; i >= 0; i--) html += `<div class="meeting-calendar-day other-month">${prevLastDate - i}</div>`;
                for (let day = 1; day <= lastDate; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isSelected = dateStr === selectedDateStr;
                    const hasMeeting = this.getMeetingsForDate(dateStr).length > 0;
                    
                    // âœ… íšŒì˜ë©”ëª¨ ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ì ìš©
                    const todayClass = this.isToday(dateStr) ? 'today-border' : '';
                    let classes = `meeting-calendar-day ${todayClass}`;
                    
                    if (isWeekend && !isSelected) classes += ' weekend';
                    if (isSelected) classes += ' selected';
                    if (hasMeeting) classes += ' has-meeting';
                    html += `<div class="${classes}" onclick="app.selectMeetingDate('${dateStr}')">${day}</div>`;
                }
                const totalCells = firstDay + lastDate;
                const remainingCells = 7 - (totalCells % 7);
                if (remainingCells < 7) for (let day = 1; day <= remainingCells; day++) html += `<div class="meeting-calendar-day other-month">${day}</div>`;
                html += '</div></div>';

                const calendarContainer = document.getElementById('meetingCalendar');
                if (calendarContainer) calendarContainer.innerHTML = html;
            },

            renderMeetingView() {
                const viewPort = document.getElementById('viewPort');
                const dateStr = this.formatDate(this.meetingDate);
                const dayOfWeek = this.days[this.meetingDate.getDay()];

                if (!viewPort.querySelector('.meeting-wrapper')) {
                    viewPort.innerHTML = `
                        <div class="meeting-wrapper">
                            <div class="meeting-cal-panel">
                                <div id="meetingCalendar"></div>
                            </div>
                            <div class="meeting-input-panel">
                                <div class="meeting-panel-title">
                                    ğŸ“ íšŒì˜ë©”ëª¨
                                    <span id="meetingPanelDate" class="meeting-date-badge">${dateStr} (${dayOfWeek})</span>
                                </div>
                                <div id="meetingCardsContainer"></div>
                                <button class="add-meeting-btn" onclick="app.addMeetingCard()">ï¼‹ íšŒì˜ ì¶”ê°€</button>
                                <div id="meetingSaveIndicator" class="save-indicator">ğŸ’¡ ì…ë ¥ 2ì´ˆ í›„ ìë™ ì €ì¥</div>
                            </div>
                        </div>
                    `;
                }

                this.meetingCalendarDate = new Date(this.meetingDate);
                this.renderMeetingCalendar();
                this.renderMeetingCards();
            },

            renderMeetingCards() {
                const container = document.getElementById('meetingCardsContainer');
                if (!container) return;
                if (this.aiGenerating) return;
                const dateStr = this.formatDate(this.meetingDate);
                const meetings = this.getMeetingsForDate(dateStr);

                if (meetings.length === 0) {
                    container.innerHTML = this.buildCardHTML(null, dateStr, 1, 1);
                } else {
                    container.innerHTML = meetings.map((m, i) =>
                        this.buildCardHTML(m, dateStr, i + 1, meetings.length)
                    ).join('');
                }
            },

            buildCardHTML(meetingData, dateStr, num, total) {
                const mid = meetingData ? meetingData.id : `__new__${dateStr}`;
                const safeSubject = (meetingData?.subject || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                const safeContent = (meetingData?.content || '').replace(/</g, '&lt;');
                const hasSubject = !!(meetingData?.subject);
                const hasContent = !!(meetingData?.content);
                return `
                    <div class="meeting-card" data-mid="${mid}">
                        <div class="meeting-card-header">
                            <span class="meeting-card-num">íšŒì˜ ${num}</span>
                            <span class="meeting-card-del" onclick="app.deleteMeetingCard('${mid}', '${dateStr}')">ğŸ—‘ ì‚­ì œ</span>
                        </div>
                        <label class="meeting-label">ğŸ“‹ íšŒì˜ ì£¼ì œ</label>
                        <input type="text"
                            class="meeting-input ${hasSubject ? 'has-data' : ''}"
                            data-mid="${mid}" data-field="subject"
                            placeholder="ì˜ˆ: í•™ìƒìƒí™œê·œì • ê°œì • í˜‘ì˜íšŒ"
                            value="${safeSubject}"
                            oninput="app.handleCardInput(this)"
                            onfocus="app.handleMeetingFocus()"
                            onblur="app.handleMeetingBlur()">
                        <label class="meeting-label">
                            <span>ğŸ“ íšŒì˜ ë‚´ìš© ì •ë¦¬</span>
                            <span style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-content:flex-end">
                                <button class="ai-generate-btn" data-mid="${mid}" onclick="app.generateAIMeetingMinutes('${mid}')">ğŸ¤– AI íšŒì˜ë¡</button>
                                <button class="pdf-btn" onclick="app.downloadPDF('${mid}')">ğŸ“„ PDF ì €ì¥</button>
                                <label class="audio-upload-btn" title="ë…¹ìŒíŒŒì¼ ë“±ë¡ í›„ í…ìŠ¤íŠ¸ ë³€í™˜">
                                    ğŸµ ë…¹ìŒíŒŒì¼ ë“±ë¡
                                    <input type="file" accept="audio/*" style="display:none" onchange="app.handleAudioFile(event,'${mid}')">
                                </label>
                                <button class="record-btn" id="recBtn_${mid}" onclick="app.toggleRecording('${mid}')">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
                            </span>
                        </label>
                        <div class="record-status" id="recStatus_${mid}"></div>
                        <div class="transcript-preview" id="recPreview_${mid}"></div>
                        <div style="position:relative">
                            <textarea
                                class="meeting-textarea ${hasContent ? 'has-data' : ''}"
                                data-mid="${mid}" data-field="content"
                                oninput="app.handleCardInput(this)"
                                onfocus="app.handleMeetingFocus()"
                                onblur="app.handleMeetingBlur()"
                            >${safeContent}</textarea>
                        </div>
                    </div>`;
            },

            addMeetingCard() {
                const dateStr = this.formatDate(this.meetingDate);
                const newId = this.newMeetingId(dateStr);
                const meetings = this.getMeetingsForDate(dateStr);
                const container = document.getElementById('meetingCardsContainer');
                if (!container) return;
                const newCard = document.createElement('div');
                newCard.innerHTML = this.buildCardHTML(null, dateStr, meetings.length + 1, meetings.length + 1);
                const card = newCard.firstElementChild;
                card.dataset.mid = newId;
                card.querySelectorAll('[data-mid]').forEach(el => el.dataset.mid = newId);
                card.querySelector('.meeting-card-del').setAttribute('onclick', `app.deleteMeetingCard('${newId}', '${dateStr}')`);
                card.querySelector('.ai-generate-btn').setAttribute('onclick', `app.generateAIMeetingMinutes('${newId}')`);
                card.querySelector('.ai-generate-btn').dataset.mid = newId;
                const recBtn = card.querySelector('.record-btn');
                if (recBtn) { recBtn.id = `recBtn_${newId}`; recBtn.setAttribute('onclick', `app.toggleRecording('${newId}')`); }
                const recStatus = card.querySelector('.record-status');
                if (recStatus) recStatus.id = `recStatus_${newId}`;
                const recPreview = card.querySelector('.transcript-preview');
                if (recPreview) recPreview.id = `recPreview_${newId}`;
                const audioInput = card.querySelector('input[type="file"]');
                if (audioInput) audioInput.setAttribute('onchange', `app.handleAudioFile(event,'${newId}')`);
                container.appendChild(card);
            },

            async deleteMeetingCard(mid, dateStr) {
                if (mid.startsWith('__new__')) {
                    const card = document.querySelector(`.meeting-card[data-mid="${mid}"]`);
                    if (card) card.remove();
                    this.renumberCards();
                    return;
                }
                const idx = this.events.findIndex(e => e.id === mid);
                if (idx !== -1) this.events.splice(idx, 1);
                this.localDeletes.add(mid);
                delete this.localChanges[mid];

                const card = document.querySelector(`.meeting-card[data-mid="${mid}"]`);
                if (card) card.remove();
                this.renumberCards();
                this.renderMeetingCalendar();
                await this.saveToServer('delete', { id: mid });
            },

            renumberCards() {
                const container = document.getElementById('meetingCardsContainer');
                if (!container) return;
                container.querySelectorAll('.meeting-card').forEach((card, i) => {
                    const numEl = card.querySelector('.meeting-card-num');
                    if (numEl) numEl.textContent = `íšŒì˜ ${i + 1}`;
                });
            },

            getMonday(d) {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.getFullYear(), date.getMonth(), diff);
            },

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            async saveEvent() {
                const dateInput = document.getElementById('inDate').value;
                const title = document.getElementById('inTitle').value;
                const dapt = document.getElementById('inDept').value;
                if (!dateInput || !title) { alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                
                // âœ… ì˜¤ë¥˜ ìˆ˜ì •: ë‚ ì§œ ì…ë ¥ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ íƒ€ì„ì¡´ ë¬¸ì œ ì™„ë²½íˆ í•´ê²°
                // dateInputì€ "YYYY-MM-DD" í˜•ì‹ì˜ ë¬¸ìì—´
                const newEvent = { id: Date.now().toString(), date: dateInput, title: title, dapt: dapt };
                this.events.push(newEvent);
                this.currentDate = this.parseLocalDate(dateInput);
                this.render();
                document.getElementById('inDate').value = '';
                document.getElementById('inTitle').value = '';
                await this.saveToServer('add', newEvent);
            },

            async deleteEvent(id) {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                this.events = this.events.filter(e => e.id !== id);
                this.render();
                await this.saveToServer('delete', { id });
                this.closeModal();
            },

            showDetail(dateStr) {
                const modal = document.getElementById('detailModal');
                const modalDate = document.getElementById('modalDate');
                const modalContent = document.getElementById('modalContent');
                const dayOfWeek = this.days[this.parseLocalDate(dateStr).getDay()];
                const holiday = this.getHoliday(dateStr);
                
                modalDate.textContent = `${dateStr} (${dayOfWeek})${holiday ? ' - ' + holiday : ''}`;
                modalContent.innerHTML = '';
                
                const dayEvents = this.events.filter(e => e.date === dateStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_'));
                const meetings = this.getMeetingsForDate(dateStr);
                meetings.forEach((meetingData, i) => {
                    modalContent.innerHTML += `<div class="bg-green-50 p-4 rounded-lg border-2 border-green-300 mb-3">
                        <div class="text-green-800 font-black mb-2">ğŸ“ íšŒì˜ë©”ëª¨ ${meetings.length > 1 ? (i+1) : ''}</div>
                        <div class="font-bold text-green-700 mb-1">${meetingData.subject || '(ì œëª© ì—†ìŒ)'}</div>
                        <div class="text-sm text-slate-600 whitespace-pre-wrap">${meetingData.content || ''}</div>
                    </div>`;
                });
                if (dayEvents.length === 0 && meetings.length === 0) {
                    modalContent.innerHTML = "<div class='text-slate-400 text-sm'>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                } else {
                    const showDelete = this.viewMode === 'weekly';
                    dayEvents.forEach(e => {
                        modalContent.innerHTML += `<div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                            <div class="dept-${e.dapt}"><span class="font-bold">[${e.dapt}]</span> ${e.title}</div>
                            ${showDelete ? `<span class="del-x text-lg" onclick="app.deleteEvent('${e.id}')">âœ•</span>` : ''}
                        </div>`;
                    });
                }
                modal.style.display = 'flex';
            },

            closeModal() { document.getElementById('detailModal').style.display = 'none'; },

            move(direction) {
                if (this.viewMode === 'yearly') this.currentDate.setFullYear(this.currentDate.getFullYear() + direction);
                else if (this.viewMode === 'monthly') this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                else if (this.viewMode === 'meeting') {
                    this.meetingCalendarDate.setMonth(this.meetingCalendarDate.getMonth() + direction);
                    this.renderMeetingCalendar();
                    return;
                } else this.currentDate.setDate(this.currentDate.getDate() + (direction * 7));
                this.render();
            },

            setView(mode) {
                this.viewMode = mode;
                if (mode !== 'meeting') {
                    this.meetingInputFocused = false;
                    this.isEditing = false;
                }
                this.render();
            },

            renderYearly() {
                const year = this.currentDate.getFullYear();
                let html = '<div class="year-view">';
                for (let m = 0; m < 12; m++) {
                    html += `<div class="year-month"><div class="year-month-title">${year}ë…„ ${m + 1}ì›”</div><div class="mini-calendar">`;
                    this.days.forEach(w => html += `<div class="text-[9px] md:text-[11px] text-slate-400 font-bold text-center p-1">${w}</div>`);
                    const first = new Date(year, m, 1).getDay();
                    const last = new Date(year, m + 1, 0).getDate();
                    for (let i = 0; i < first; i++) html += '<div></div>';
                    for (let d = 1; d <= last; d++) {
                        const dateStr = `${year}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const dayIdx = new Date(year, m, d).getDay();
                        const hasEvent = this.events.some(e => e.date === dateStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_'));
                        const holiday = this.getHoliday(dateStr);
                        const isSpecial = this.isSpecialHoliday(dateStr);
                        const isWeekend = dayIdx === 0 || dayIdx === 6;
                        const colorClass = dayIdx === 0 || holiday ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-600');
                        const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                        
                        // âœ… ì—°ê°„ ë·° ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ì ìš©
                        const todayClass = this.isToday(dateStr) ? 'today-border' : '';
                        const cellClass = holiday || isWeekend ? 'weekend' : (hasEvent ? 'has-event' : '');
                        html += `<div class="mini-day ${cellClass} ${colorClass} ${holidayClass} ${todayClass}" onclick="app.showDetail('${dateStr}')">${d}</div>`;
                    }
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderMonthly() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                let html = '<div class="calendar-grid">';
                this.days.forEach(w => html += `<div class="bg-slate-50 p-2 text-center text-[10px] md:text-sm font-bold text-slate-400">${w}</div>`);
                const first = new Date(year, month, 1).getDay();
                const last = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < first; i++) html += '<div class="day-cell bg-slate-50/30"></div>';
                for (let d = 1; d <= last; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayIdx = new Date(year, month, d).getDay();
                    const holiday = this.getHoliday(dateStr);
                    const isSpecial = this.isSpecialHoliday(dateStr);
                    const isWeekend = dayIdx === 0 || dayIdx === 6;
                    const colorClass = dayIdx === 0 || holiday ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-400');
                    const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                    
                    // âœ… ì›”ê°„ ë·° ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ì ìš©
                    const todayClass = this.isToday(dateStr) ? 'today-border' : '';
                    html += `<div class="day-cell ${holidayClass} ${todayClass}" onclick="app.showDetail('${dateStr}')">
                        <div class="day-cell-header ${colorClass}">${d}</div>`;
                    if (holiday) html += `<div class="day-cell-holiday">${holiday}</div>`;
                    html += '<div class="day-cell-events">';
                    const dayEvts = this.events.filter(e => e.date === dateStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_'));
                    const maxShow = window.innerWidth < 768 ? 2 : 3;
                    dayEvts.slice(0, maxShow).forEach(e => {
                        const displayTitle = window.innerWidth < 768 ? e.title.substring(0, 4) : e.title;
                        html += `<div class="event-item dept-${e.dapt}" onclick="event.stopPropagation(); app.showDetail('${dateStr}')" title="${e.title}">${displayTitle}</div>`;
                    });
                    if (dayEvts.length > maxShow) {
                        html += `<div class="event-more" onclick="event.stopPropagation(); app.showDetail('${dateStr}')">+${dayEvts.length - maxShow}ê°œ ë”</div>`;
                    }
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderWeekly() {
                const monday = this.getMonday(this.currentDate);
                const dateStr = this.formatDate(monday);
                if (!this.isEditing) {
                    document.querySelectorAll('.notice-input').forEach(input => {
                        const dept = input.dataset.dept;
                        const notice = this.events.find(e => e.id === `notice_${dateStr}_${dept}`);
                        input.value = notice ? notice.title : '';
                        this.updateInputStyle(input);
                    });
                }
                let html = '<div class="flex flex-col gap-2">';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    const dStr = this.formatDate(d);
                    const holiday = this.getHoliday(dStr);
                    const isSpecial = this.isSpecialHoliday(dStr);
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                    const dayOfWeek = this.days[d.getDay()];
                    const colorClass = d.getDay() === 0 || holiday ? 'text-sun' : (d.getDay() === 6 ? 'text-sat' : 'text-green-800');
                    
                    // âœ… ì£¼ê°„ ë·° ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ì ìš©
                    const todayClass = this.isToday(dStr) ? 'today-border' : '';
                    html += `<div class="week-item ${holidayClass} ${todayClass} p-4 rounded-xl border flex items-center shadow-sm cursor-pointer hover:shadow-md" onclick="app.showDetail('${dStr}')">
                        <div class="w-20 md:w-28 week-date-label font-black ${colorClass} border-r mr-4">${d.getDate()}ì¼(${dayOfWeek})`;
                    if (holiday) html += `<div class="holiday-badge">${holiday}</div>`;
                    html += '</div><div class="flex-1">';
                    this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_')).forEach(e => {
                        html += `<div class="event-item-week dept-${e.dapt}" onclick="event.stopPropagation()">
                            <span>${e.title} (${e.dapt})</span>
                            <span class="del-x" onclick="app.deleteEvent('${e.id}')">âœ•</span>
                        </div>`;
                    });
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            handleCardInput(input) {
                this.isEditing = true;
                this.meetingInputFocused = true;
                this.updateMeetingInputStyle(input);
                this.showSaveIndicator('saving');
                if (this.saveTimers['meeting']) clearTimeout(this.saveTimers['meeting']);
                this.saveTimers['meeting'] = setTimeout(() => { this.saveAllCards(); }, 2000);
            },

            handleMeetingFocus() { this.meetingInputFocused = true; this.isEditing = true; },
            handleMeetingBlur() {
                setTimeout(() => {
                    if (!this.isMeetingInputActive()) {
                        this.meetingInputFocused = false;
                        this.isEditing = false;
                    }
                }, 300);
            },

            updateMeetingInputStyle(input) {
                if (input.value.trim() !== '') input.classList.add('has-data');
                else input.classList.remove('has-data');
            },

            async saveAllCards() {
                if (!this.isMeetingInputActive()) {
                    this.isEditing = false;
                    this.meetingInputFocused = false;
                }
                const dateStr = this.formatDate(this.meetingDate);
                const container = document.getElementById('meetingCardsContainer');
                if (!container) return;

                const cards = container.querySelectorAll('.meeting-card');
                let cardNum = 1;

                for (const card of cards) {
                    const oldMid = card.dataset.mid;
                    const subjectEl = card.querySelector('[data-field="subject"]');
                    const contentEl = card.querySelector('[data-field="content"]');
                    const subject = subjectEl?.value.trim() || '';
                    const content = contentEl?.value.trim() || '';

                    if (!subject && !content) {
                        if (!oldMid.startsWith('__new__')) {
                            const idx = this.events.findIndex(e => e.id === oldMid);
                            if (idx !== -1) this.events.splice(idx, 1);
                            this.localDeletes.add(oldMid);
                            delete this.localChanges[oldMid];
                            await this.saveToServer('delete', { id: oldMid });
                        }
                        continue;
                    }

                    let mid = oldMid;
                    if (oldMid.startsWith('__new__')) {
                        mid = `meeting_${dateStr}_${cardNum}`;
                        card.dataset.mid = mid;
                        card.querySelectorAll('[data-mid]').forEach(el => el.dataset.mid = mid);
                        card.querySelector('.meeting-card-del').setAttribute('onclick', `app.deleteMeetingCard('${mid}', '${dateStr}')`);
                        const aiBtn = card.querySelector('.ai-generate-btn');
                        if (aiBtn) {
                            aiBtn.setAttribute('onclick', `app.generateAIMeetingMinutes('${mid}')`);
                            aiBtn.dataset.mid = mid;
                        }
                    }

                    const meetingData = {
                        id: mid, date: dateStr,
                        title: subject || '(ì œëª© ì—†ìŒ)',
                        dapt: 'meeting', subject, content
                    };
                    const idx = this.events.findIndex(e => e.id === mid);
                    if (idx !== -1) this.events[idx] = meetingData;
                    else this.events.push(meetingData);

                    this.localDeletes.delete(mid);
                    await this.saveToServer('add', meetingData);
                    cardNum++;
                }
                this.renderMeetingCalendar();
            },

            /* ===== PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (html2canvas ë°©ì‹ - í•œê¸€ ì™„ë²½ ì§€ì›) ===== */
            async downloadPDF(mid) {
                const card = document.querySelector(`.meeting-card[data-mid="${mid}"]`);
                if (!card) return;

                const subjectEl = card.querySelector('[data-field="subject"]');
                const contentEl = card.querySelector('[data-field="content"]');
                const subject = subjectEl ? subjectEl.value.trim() : 'íšŒì˜ë¡';
                const content = contentEl ? contentEl.value.trim() : '';

                if (!content) { this.showToast('ğŸ“ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

                const btn = card.querySelector('.pdf-btn');
                if (btn) { btn.disabled = true; btn.textContent = 'â³ ìƒì„± ì¤‘...'; }

                try {
                    const dateStr = this.formatDate(this.meetingDate);
                    const dayOfWeek = this.days[this.meetingDate.getDay()];

                    // â”€â”€ í™”ë©´ì— ë³´ì´ì§€ ì•ŠëŠ” ì¸ì‡„ìš© DOM ìƒì„± â”€â”€
                    const printDiv = document.createElement('div');
                    printDiv.style.cssText = `
                        position:fixed; left:-9999px; top:0;
                        width:794px; background:white;
                        font-family:'Apple SD Gothic Neo','Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;
                        font-size:14px; line-height:1.8; color:#1e293b; padding:0;
                    `;

                    // í—¤ë”
                    printDiv.innerHTML = `
                        <div style="background:linear-gradient(135deg,#16a34a,#15803d);color:white;padding:18px 32px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:18px;font-weight:900;">ğŸ« êµ¬ë¡€ì¤‘ íšŒì˜ë¡</span>
                            <span style="font-size:13px;opacity:0.9;">${dateStr} (${dayOfWeek})</span>
                        </div>
                        <div style="padding:28px 32px 32px;">
                            <h1 style="font-size:22px;font-weight:900;color:#1e293b;margin:0 0 12px 0;line-height:1.4;">${subject || '(ì œëª© ì—†ìŒ)'}</h1>
                            <div style="height:3px;background:linear-gradient(90deg,#16a34a,#86efac);border-radius:2px;margin-bottom:20px;"></div>

                            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px 18px;margin-bottom:24px;font-size:13px;color:#15803d;">
                                <div style="margin-bottom:6px;">ğŸ“… <strong>íšŒì˜ ì¼ì</strong> : ${dateStr} (${dayOfWeek})</div>
                                <div>ğŸ“‹ <strong>íšŒì˜ ì£¼ì œ</strong> : ${subject || '(ì œëª© ì—†ìŒ)'}</div>
                            </div>

                            <div style="font-size:15px;font-weight:900;color:#1e293b;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #e2e8f0;">ğŸ“ íšŒì˜ ë‚´ìš©</div>
                            <div style="font-size:14px;color:#334155;line-height:2;white-space:pre-wrap;word-break:break-all;">${content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>

                            <div style="margin-top:36px;padding-top:14px;border-top:1px solid #e2e8f0;text-align:center;font-size:12px;color:#94a3b8;">
                                êµ¬ë¡€ì¤‘í•™êµ | íšŒì˜ë¡ | ${dateStr}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(printDiv);

                    // html2canvas ìº¡ì²˜
                    const canvas = await html2canvas(printDiv, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    document.body.removeChild(printDiv);

                    // jsPDFì— ì´ë¯¸ì§€ë¡œ ì‚½ì… (A4 í¬ê¸°ì— ë§ê²Œ)
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdfW = 210; // A4 mm
                    const pdfH = (canvas.height * pdfW) / canvas.width;

                    // ê¸´ ë‚´ìš©ì€ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
                    const pageHeight = 297;
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                    if (pdfH <= pageHeight) {
                        doc.addImage(imgData, 'PNG', 0, 0, pdfW, pdfH);
                    } else {
                        // í˜ì´ì§€ ë¶„í• 
                        let yOffset = 0;
                        const ratio = canvas.width / pdfW;
                        while (yOffset < pdfH) {
                            if (yOffset > 0) doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, -yOffset, pdfW, pdfH);
                            yOffset += pageHeight;
                        }
                    }

                    const fileName = `íšŒì˜ë¡_${dateStr}_${(subject || 'ë¬´ì œ').replace(/[\/\\?%*:|"<>]/g, '_')}.pdf`;
                    doc.save(fileName);
                    this.showToast('âœ… PDFê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch (err) {
                    console.error('PDF ì˜¤ë¥˜:', err);
                    this.showToast('âŒ PDF ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'ğŸ“„ PDF ì €ì¥'; }
                }
            },

            /* ===== ë…¹ìŒ ê¸°ëŠ¥ (ë™ê¸°í™” + ëª¨ë°”ì¼ 30ë¶„+ ì§€ì›) ===== */
            _recognition: null,
            _recordingMid: null,
            _isRecording: false,
            _recordingFinalText: '',   // ì„¸ì…˜ ì „ì²´ ëˆ„ì  í…ìŠ¤íŠ¸
            _recordingUserStopped: false,

            toggleRecording(mid) {
                if (this._isRecording && this._recordingMid === mid) {
                    this._recordingUserStopped = true;
                    this.stopRecording();
                } else {
                    if (this._isRecording) {
                        this._recordingUserStopped = true;
                        this.stopRecording();
                    }
                    this.startRecording(mid);
                }
            },

            startRecording(mid) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    this.showToast('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ìƒˆ ì„¸ì…˜ ì‹œì‘ ì‹œ ì´ˆê¸°í™”
                this._recordingMid = mid;
                this._isRecording = true;
                this._recordingUserStopped = false;
                if (!this._recordingFinalText) this._recordingFinalText = '';

                const btn = document.getElementById(`recBtn_${mid}`);
                const statusEl = document.getElementById(`recStatus_${mid}`);
                const previewEl = document.getElementById(`recPreview_${mid}`);
                const getTextarea = () => document.querySelector(`.meeting-textarea[data-mid="${mid}"]`);

                // UI ì—…ë°ì´íŠ¸
                if (btn) { btn.textContent = 'â¹ ë…¹ìŒ ì¤‘ì§€'; btn.classList.add('recording'); }
                if (statusEl) statusEl.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘... ë§ì”€í•˜ì„¸ìš”';
                if (previewEl) previewEl.classList.add('visible');

                const rec = new SpeechRecognition();
                rec.lang = 'ko-KR';
                rec.continuous = true;
                rec.interimResults = true;
                rec.maxAlternatives = 1;

                let sessionFinal = '';  // ì´ë²ˆ recognition ì„¸ì…˜ì˜ í™•ì • í…ìŠ¤íŠ¸

                rec.onresult = (e) => {
                    let interim = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        if (e.results[i].isFinal) sessionFinal += e.results[i][0].transcript;
                        else interim += e.results[i][0].transcript;
                    }
                    if (previewEl) {
                        const combined = this._recordingFinalText + sessionFinal;
                        previewEl.textContent = (interim || (combined.slice(-60) + (combined.length > 60 ? '...' : '')));
                    }
                };

                rec.onend = () => {
                    // ì´ë²ˆ ì„¸ì…˜ í…ìŠ¤íŠ¸ë¥¼ ì „ì²´ ëˆ„ì ì— ì¶”ê°€
                    this._recordingFinalText += sessionFinal;

                    if (!this._recordingUserStopped && this._isRecording) {
                        // ëª¨ë°”ì¼ì—ì„œ ìë™ ì¤‘ë‹¨ëì„ ë•Œ â†’ ì¦‰ì‹œ ì¬ì‹œì‘ (30ë¶„+ ì—°ì† ë…¹ìŒ)
                        setTimeout(() => {
                            if (!this._recordingUserStopped && this._isRecording) {
                                this.startRecording(mid);
                            }
                        }, 300);
                        return;
                    }

                    // ì‚¬ìš©ìê°€ ì¤‘ì§€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
                    this._isRecording = false;
                    this._recordingMid = null;
                    if (btn) { btn.textContent = 'ğŸ™ ë…¹ìŒ ì‹œì‘'; btn.classList.remove('recording'); }
                    if (statusEl) statusEl.textContent = '';
                    if (previewEl) { previewEl.classList.remove('visible'); previewEl.textContent = ''; }

                    const finalText = this._recordingFinalText.trim();
                    this._recordingFinalText = '';  // ì´ˆê¸°í™”

                    if (finalText) {
                        const textarea = getTextarea();
                        if (textarea) {
                            const existing = textarea.value.trim();
                            textarea.value = existing
                                ? existing + '\n\n[ğŸ™ ë…¹ìŒ ë‚´ìš©]\n' + finalText
                                : finalText;
                            textarea.classList.add('has-data');
                            // âœ… í•µì‹¬: handleCardInput â†’ saveAllCards â†’ saveToServer í˜¸ì¶œë¡œ ë™ê¸°í™”
                            this.handleCardInput(textarea);
                            this.showToast('âœ… ë…¹ìŒ ë‚´ìš©ì´ ì €ì¥Â·ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        }
                    }
                };

                rec.onerror = (e) => {
                    if (e.error === 'no-speech' || e.error === 'aborted') return; // ë¬´ì‹œ (ìë™ ì¬ì‹œì‘)
                    const msgs = {
                        'not-allowed': 'ë§ˆì´í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.',
                        'network': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                    };
                    this.showToast('âš ï¸ ' + (msgs[e.error] || 'ë…¹ìŒ ì˜¤ë¥˜: ' + e.error), 'error');
                };

                this._recognition = rec;
                try { rec.start(); } catch(e) { /* ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ë¬´ì‹œ */ }
            },

            stopRecording() {
                if (this._recognition) {
                    try { this._recognition.stop(); } catch(e) {}
                    this._recognition = null;
                }
            },

            /* ===== ë…¹ìŒíŒŒì¼ ë“±ë¡ â†’ í…ìŠ¤íŠ¸ ë³€í™˜ ===== */
            handleAudioFile(event, mid) {
                const file = event.target.files[0];
                if (!file) return;

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    this.showToast('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const statusEl = document.getElementById(`recStatus_${mid}`);
                const previewEl = document.getElementById(`recPreview_${mid}`);
                const textarea = document.querySelector(`.meeting-textarea[data-mid="${mid}"]`);

                // ì˜¤ë””ì˜¤ íŒŒì¼ì„ Audio ì—˜ë¦¬ë¨¼íŠ¸ë¡œ ì¬ìƒí•˜ë©´ì„œ Web Speech APIë¡œ ì¸ì‹
                const url = URL.createObjectURL(file);
                const audio = new Audio(url);
                audio.playbackRate = 1.0;

                if (statusEl) statusEl.textContent = 'ğŸµ íŒŒì¼ ë³€í™˜ ì¤‘... ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
                if (previewEl) previewEl.classList.add('visible');

                const rec = new SpeechRecognition();
                rec.lang = 'ko-KR';
                rec.continuous = true;
                rec.interimResults = true;

                let fullText = '';

                rec.onresult = (e) => {
                    let interim = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        if (e.results[i].isFinal) fullText += e.results[i][0].transcript;
                        else interim += e.results[i][0].transcript;
                    }
                    if (previewEl) previewEl.textContent = interim || fullText.slice(-80) + '...';
                };

                rec.onend = () => {
                    audio.pause();
                    URL.revokeObjectURL(url);
                    if (statusEl) statusEl.textContent = '';
                    if (previewEl) { previewEl.classList.remove('visible'); previewEl.textContent = ''; }

                    const finalText = fullText.trim();
                    if (finalText && textarea) {
                        const existing = textarea.value.trim();
                        textarea.value = existing
                            ? existing + '\n\n[ğŸµ íŒŒì¼ ë³€í™˜ ë‚´ìš©]\n' + finalText
                            : finalText;
                        textarea.classList.add('has-data');
                        this.handleCardInput(textarea);
                        this.showToast('âœ… ë…¹ìŒíŒŒì¼ì´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        this.showToast('âš ï¸ ë³€í™˜ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    }
                };

                rec.onerror = (e) => {
                    if (e.error === 'no-speech' || e.error === 'aborted') return;
                    audio.pause();
                    URL.revokeObjectURL(url);
                    if (statusEl) statusEl.textContent = '';
                    if (previewEl) previewEl.classList.remove('visible');
                    this.showToast('âš ï¸ ë³€í™˜ ì˜¤ë¥˜: ' + e.error, 'error');
                };

                // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘ê³¼ í•¨ê»˜ ì¸ì‹ ì‹œì‘
                audio.oncanplaythrough = () => {
                    rec.start();
                    audio.play();
                };

                audio.onended = () => {
                    setTimeout(() => { try { rec.stop(); } catch(e) {} }, 1000);
                };

                audio.onerror = () => {
                    this.showToast('âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    if (statusEl) statusEl.textContent = '';
                };

                // íŒŒì¼ input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
                event.target.value = '';
            },

            async generateAIMeetingMinutes(mid) {
                const card = document.querySelector(`.meeting-card[data-mid="${mid}"]`);
                if (!card) return;
                const subjectEl = card.querySelector('[data-field="subject"]');
                const contentEl = card.querySelector('[data-field="content"]');
                const aiBtn = card.querySelector('.ai-generate-btn');
                const subject = subjectEl.value.trim();
                const content = contentEl.value.trim();

                if (!content) { this.showToast('ğŸ“ ëª¨ì„ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

                if (mid.startsWith('__new__')) {
                    await this.saveAllCards();
                    mid = card.dataset.mid;
                }

                this.aiGenerating = true;
                if (aiBtn) { aiBtn.disabled = true; aiBtn.innerHTML = 'â³ AI ë¶„ì„ì¤‘...'; }

                const textareaWrapper = contentEl.parentElement;
                const overlay = document.createElement('div');
                overlay.className = 'ai-overlay';
                overlay.innerHTML = '<div class="ai-spinner">ğŸ¤– AIê°€ íšŒì˜ë¡ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';
                textareaWrapper.appendChild(overlay);
                contentEl.style.opacity = '0.4';

                try {
                    const response = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'generateAI', subject, content, meetingDate: this.formatDate(this.meetingDate) })
                    });
                    const resData = await response.json();

                    if (resData.success && resData.minutes) {
                        contentEl.value = resData.minutes;
                        contentEl.classList.add('has-data');
                        const updatedData = {
                            id: mid, date: this.formatDate(this.meetingDate),
                            title: subject || '(ì œëª© ì—†ìŒ)', dapt: 'meeting',
                            subject, content: resData.minutes
                        };
                        const idx = this.events.findIndex(e => e.id === mid);
                        if (idx !== -1) this.events[idx] = updatedData;
                        else this.events.push(updatedData);
                        this.localChanges[mid] = updatedData;
                        await this.saveToServer('add', updatedData);
                        this.showToast('âœ… AI íšŒì˜ë¡ ì™„ì„±!', 'success');
                    }
                } catch (err) { console.error('AI ì˜¤ë¥˜:', err); }
                finally {
                    this.aiGenerating = false;
                    if (aiBtn) { aiBtn.disabled = false; aiBtn.innerHTML = 'ğŸ¤– AI íšŒì˜ë¡'; }
                    overlay.remove(); contentEl.style.opacity = '1';
                }
            },

            render() {
                const viewPort = document.getElementById('viewPort');
                const titleText = document.getElementById('titleText');
                const noticePort = document.getElementById('noticePort');
                const eventInputSection = document.getElementById('eventInputSection');
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth() + 1;

                if (this.viewMode === 'meeting') {
                    titleText.textContent = 'ğŸ“ íšŒì˜ë©”ëª¨';
                    noticePort.classList.add('hidden');
                    eventInputSection.classList.add('hidden');
                    this.renderMeetingView();
                } else {
                    eventInputSection.classList.remove('hidden');
                    if (viewPort.querySelector('.meeting-wrapper')) viewPort.innerHTML = '';

                    if (this.viewMode === 'yearly') {
                        titleText.textContent = `${year}ë…„ ì „ì²´ í•™ì‚¬ë ¥`;
                        viewPort.innerHTML = this.renderYearly();
                        noticePort.classList.add('hidden');
                    } else if (this.viewMode === 'monthly') {
                        titleText.textContent = `${year}ë…„ ${month}ì›”`;
                        viewPort.innerHTML = this.renderMonthly();
                        noticePort.classList.add('hidden');
                    } else {
                        titleText.textContent = `${year}ë…„ ${month}ì›” ì£¼ê°„ê³„íš`;
                        viewPort.innerHTML = this.renderWeekly();
                        noticePort.classList.remove('hidden');
                    }
                }
            },

            async init() {
                await this.loadFromServer();
                this.render();
                setInterval(() => {
                    if (!this.isEditing && !this.meetingInputFocused) this.loadFromServer();
                }, 10000);
            }
        };
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ'))
                    .catch(err => console.log('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }

        let deferredPrompt = null;
        const installBtn = document.getElementById('installBtn');
        const isStandalone = window.navigator.standalone === true ||
                             window.matchMedia('(display-mode: standalone)').matches;

        if (!isStandalone) {
            const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
            if (isIOS) installBtn.style.display = 'block';
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block';
            });
        }

        app.handleInstall = async function() {
            const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
            if (isIOS) document.getElementById('iosInstallModal').style.display = 'flex';
            else if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        };
    </script>
</body>
</html>
